FROM aist.python3

USER root

COPY CeleryConfig/celery_app.py /app

COPY Deployment/flower/core_nginx.conf /etc/nginx/nginx.conf
COPY Deployment/flower/nginx.conf /etc/nginx/conf.d/
COPY Deployment/flower/supervisord.conf /etc/supervisor/conf.d/supervisord.conf

ENV PATH /bin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin:/sbin

ENV PORT 9001

CMD export uri="\$uri" \
    export http_upgrade="\$http_upgrade" \
    && envsubst < /etc/nginx/conf.d/nginx.conf > subst_ \
    && cat subst_ \
    && cp subst_ /etc/nginx/conf.d/nginx.conf \
    && /usr/bin/supervisord